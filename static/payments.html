<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureTradeAPI - Payments</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: #fff;
            min-height: 100vh;
        }

        .payments-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: #cbd5e1;
            font-size: 1.1rem;
        }

        .payments-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .section-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .section-card h2 {
            color: #10b981;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .balance-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .balance-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 5px;
        }

        .balance-currency {
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #cbd5e1;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }

        .payment-method {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .method-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .method-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #10b981;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .method-details h4 {
            margin: 0;
            color: #10b981;
            font-size: 1rem;
        }

        .method-details p {
            margin: 5px 0 0 0;
            color: #cbd5e1;
            font-size: 0.8rem;
        }

        .method-actions {
            display: flex;
            gap: 10px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #10b981;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .transaction-type {
            font-weight: bold;
            color: #10b981;
            text-transform: uppercase;
        }

        .transaction-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-completed {
            background: #10b981;
            color: white;
        }

        .status-pending {
            background: #f59e0b;
            color: white;
        }

        .status-processing {
            background: #3b82f6;
            color: white;
        }

        .status-failed {
            background: #ef4444;
            color: white;
        }

        .transaction-details {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .transaction-amount {
            font-size: 1.1rem;
            font-weight: bold;
            color: #10b981;
        }

        .fees-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .fees-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fee-item:last-child {
            border-bottom: none;
        }

        .fee-label {
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .fee-value {
            color: #10b981;
            font-weight: bold;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .chart-wrapper {
            height: 300px;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #10b981;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #cbd5e1;
            font-size: 0.9rem;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #10b981;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #059669;
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #cbd5e1;
        }

        .loading .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #0f172a;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #10b981;
        }

        .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-left-color: #10b981;
            color: #10b981;
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            color: #ef4444;
        }

        .amount-input {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #10b981;
            font-weight: bold;
        }

        .amount-input input {
            padding-left: 30px;
        }

        .crypto-address {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
            color: #10b981;
            margin-top: 10px;
            word-break: break-all;
        }

        @media (max-width: 1024px) {
            .payments-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .payments-container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="payments-container">
        <a href="/static/trading.html" class="back-link">‚Üê Back to Trading</a>
        
        <div class="header">
            <h1>üí≥ Payments</h1>
            <p>Manage deposits, withdrawals, and payment methods</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading payment data...</p>
        </div>

        <div id="payments-content" style="display: none;">
            <div class="balance-summary">
                <h2>üí∞ Account Balance</h2>
                <div class="balance-grid" id="balance-grid">
                    <!-- Balance items will be populated here -->
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-deposited">$0</div>
                    <div class="stat-label">Total Deposited</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-withdrawn">$0</div>
                    <div class="stat-label">Total Withdrawn</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="net-flow">$0</div>
                    <div class="stat-label">Net Flow</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-fees">$0</div>
                    <div class="stat-label">Total Fees</div>
                </div>
            </div>

            <div class="payments-grid">
                <div class="section-card">
                    <h2>üí≥ Payment Methods</h2>
                    <div id="payment-methods-list"></div>
                    <button class="btn btn-primary" onclick="openAddMethodModal()" style="width: 100%; margin-top: 15px;">
                        Add Payment Method
                    </button>
                </div>

                <div class="section-card">
                    <h2>üí∏ Quick Actions</h2>
                    
                    <div class="form-group">
                        <label for="action-amount">Amount</label>
                        <div class="amount-input">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="action-amount" placeholder="0.00" step="0.01" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="action-currency">Currency</label>
                        <select id="action-currency">
                            <option value="USDT">USDT</option>
                            <option value="USD">USD</option>
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="action-method">Payment Method</label>
                        <select id="action-method">
                            <option value="card">Credit/Debit Card</option>
                            <option value="bank_transfer">Bank Transfer</option>
                            <option value="crypto">Cryptocurrency</option>
                            <option value="paypal">PayPal</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <button class="btn btn-primary" onclick="processDeposit()">
                            Deposit
                        </button>
                        <button class="btn btn-secondary" onclick="processWithdrawal()">
                            Withdraw
                        </button>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h2>üìä Transaction History</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="filterTransactions('all')">All</button>
                    <button class="btn btn-secondary" onclick="filterTransactions('deposit')">Deposits</button>
                    <button class="btn btn-secondary" onclick="filterTransactions('withdrawal')">Withdrawals</button>
                </div>
                <div id="transactions-list"></div>
            </div>

            <div class="chart-container">
                <h2>üìà Payment History</h2>
                <div class="chart-wrapper">
                    <canvas id="payments-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Payment Method Modal -->
    <div id="add-method-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Add Payment Method</h3>
                <button class="close-btn" onclick="closeAddMethodModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="method-type">Payment Method Type</label>
                <select id="method-type" onchange="updateMethodForm()">
                    <option value="">Select Type</option>
                    <option value="card">Credit/Debit Card</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="crypto">Cryptocurrency Wallet</option>
                    <option value="paypal">PayPal</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="method-name">Method Name</label>
                <input type="text" id="method-name" placeholder="e.g., My Visa Card">
            </div>
            
            <div id="method-details">
                <!-- Method-specific fields will be populated here -->
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeAddMethodModal()" style="flex: 1;">
                    Cancel
                </button>
                <button class="btn btn-primary" onclick="addPaymentMethod()" style="flex: 1;">
                    Add Method
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8002/api/v1';
        let currentToken = localStorage.getItem('auth_token');
        let paymentMethods = [];
        let transactions = [];
        let balances = {};
        let fees = {};
        let currentFilter = 'all';

        if (!currentToken) {
            window.location.href = '/static/auth.html';
        } else {
            loadPaymentData();
        }

        async function loadPaymentData() {
            try {
                const [
                    methodsResponse,
                    transactionsResponse,
                    balancesResponse,
                    feesResponse,
                    historyResponse
                ] = await Promise.all([
                    fetch(`${API_BASE}/payments/methods`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/payments/transactions`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/wallet/balances`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/payments/fees`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    }),
                    fetch(`${API_BASE}/payments/history`, {
                        headers: { 'Authorization': `Bearer ${currentToken}` }
                    })
                ]);

                if (methodsResponse.ok && transactionsResponse.ok && balancesResponse.ok && feesResponse.ok && historyResponse.ok) {
                    const methodsData = await methodsResponse.json();
                    const transactionsData = await transactionsResponse.json();
                    const balancesData = await balancesResponse.json();
                    const feesData = await feesResponse.json();
                    const historyData = await historyResponse.json();
                    
                    paymentMethods = methodsData.payment_methods;
                    transactions = transactionsData.transactions;
                    balances = balancesData.balances;
                    fees = feesData;
                    
                    updateBalanceGrid();
                    updatePaymentMethodsList();
                    updateTransactionsList();
                    updateStats(historyData.summary);
                    createPaymentsChart(historyData.monthly_stats);
                    
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('payments-content').style.display = 'block';
                } else {
                    showError('Failed to load payment data');
                }
            } catch (error) {
                showError('Error loading payment data: ' + error.message);
            }
        }

        function updateBalanceGrid() {
            const balanceGrid = document.getElementById('balance-grid');
            
            let html = '';
            Object.entries(balances).forEach(([currency, balance]) => {
                if (balance.available > 0) {
                    html += `
                        <div class="balance-item">
                            <div class="balance-amount">${balance.available.toFixed(2)}</div>
                            <div class="balance-currency">${currency}</div>
                        </div>
                    `;
                }
            });
            
            if (html === '') {
                html = '<div class="balance-item"><div class="balance-amount">0.00</div><div class="balance-currency">No funds</div></div>';
            }
            
            balanceGrid.innerHTML = html;
        }

        function updatePaymentMethodsList() {
            const methodsList = document.getElementById('payment-methods-list');
            
            if (paymentMethods.length === 0) {
                methodsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No payment methods added yet.</p>';
                return;
            }

            let html = '';
            paymentMethods.forEach(method => {
                const iconMap = {
                    'card': 'üí≥',
                    'bank_transfer': 'üè¶',
                    'crypto': '‚Çø',
                    'paypal': 'üÖøÔ∏è'
                };

                html += `
                    <div class="payment-method">
                        <div class="method-info">
                            <div class="method-icon">${iconMap[method.type] || 'üí≥'}</div>
                            <div class="method-details">
                                <h4>${method.name}</h4>
                                <p>${method.type.replace('_', ' ').toUpperCase()}</p>
                                ${method.is_default ? '<p style="color: #10b981;">Default</p>' : ''}
                            </div>
                        </div>
                        <div class="method-actions">
                            <button class="btn btn-danger" onclick="deletePaymentMethod(${method.id})">Delete</button>
                        </div>
                    </div>
                `;
            });
            
            methodsList.innerHTML = html;
        }

        function updateTransactionsList() {
            const transactionsList = document.getElementById('transactions-list');
            let filteredTransactions = transactions;

            if (currentFilter !== 'all') {
                filteredTransactions = transactions.filter(t => t.type === currentFilter);
            }

            if (filteredTransactions.length === 0) {
                transactionsList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">No transactions found.</p>';
                return;
            }

            let html = '';
            filteredTransactions.forEach(transaction => {
                html += `
                    <div class="transaction-item">
                        <div class="transaction-header">
                            <div class="transaction-type">${transaction.type}</div>
                            <div class="transaction-status status-${transaction.status}">${transaction.status}</div>
                        </div>
                        <div class="transaction-details">
                            <div>
                                <strong>Amount:</strong>
                                <div class="transaction-amount">${transaction.amount} ${transaction.currency}</div>
                            </div>
                            <div>
                                <strong>Method:</strong>
                                <div>${transaction.payment_method.replace('_', ' ').toUpperCase()}</div>
                            </div>
                            <div>
                                <strong>Date:</strong>
                                <div>${new Date(transaction.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">
                            ID: ${transaction.transaction_id} | Fees: $${transaction.fees.toFixed(2)}
                        </div>
                    </div>
                `;
            });
            
            transactionsList.innerHTML = html;
        }

        function updateStats(summary) {
            document.getElementById('total-deposited').textContent = `$${summary.total_deposited.toFixed(2)}`;
            document.getElementById('total-withdrawn').textContent = `$${summary.total_withdrawn.toFixed(2)}`;
            document.getElementById('net-flow').textContent = `$${summary.net_flow.toFixed(2)}`;
            document.getElementById('total-fees').textContent = `$${summary.total_fees.toFixed(2)}`;
        }

        function createPaymentsChart(monthlyStats) {
            const ctx = document.getElementById('payments-chart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthlyStats.map(stat => stat.month),
                    datasets: [
                        {
                            label: 'Deposits',
                            data: monthlyStats.map(stat => stat.deposits),
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Withdrawals',
                            data: monthlyStats.map(stat => stat.withdrawals),
                            backgroundColor: 'rgba(239, 68, 68, 0.8)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#cbd5e1'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#cbd5e1',
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function filterTransactions(type) {
            currentFilter = type;
            updateTransactionsList();
        }

        async function processDeposit() {
            const amount = parseFloat(document.getElementById('action-amount').value);
            const currency = document.getElementById('action-currency').value;
            const paymentMethod = document.getElementById('action-method').value;
            
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/payments/deposit`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: currency,
                        payment_method: paymentMethod
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccess(`Deposit of $${amount} ${currency} completed successfully!`);
                    loadPaymentData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('action-amount').value = '';
                } else {
                    const error = await response.json();
                    showError(`Deposit failed: ${error.detail}`);
                }
            } catch (error) {
                showError('Error processing deposit: ' + error.message);
            }
        }

        async function processWithdrawal() {
            const amount = parseFloat(document.getElementById('action-amount').value);
            const currency = document.getElementById('action-currency').value;
            const paymentMethod = document.getElementById('action-method').value;
            
            if (!amount || amount <= 0) {
                showError('Please enter a valid amount');
                return;
            }
            
            const destination = prompt('Enter withdrawal destination (e.g., bank account, crypto address):');
            if (!destination) return;
            
            try {
                const response = await fetch(`${API_BASE}/payments/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        currency: currency,
                        payment_method: paymentMethod,
                        destination: destination
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showSuccess(`Withdrawal of $${amount} ${currency} completed successfully!`);
                    loadPaymentData(); // Refresh data
                    
                    // Clear form
                    document.getElementById('action-amount').value = '';
                } else {
                    const error = await response.json();
                    showError(`Withdrawal failed: ${error.detail}`);
                }
            } catch (error) {
                showError('Error processing withdrawal: ' + error.message);
            }
        }

        function openAddMethodModal() {
            document.getElementById('add-method-modal').classList.add('active');
        }

        function closeAddMethodModal() {
            document.getElementById('add-method-modal').classList.remove('active');
            document.getElementById('method-type').value = '';
            document.getElementById('method-name').value = '';
            document.getElementById('method-details').innerHTML = '';
        }

        function updateMethodForm() {
            const methodType = document.getElementById('method-type').value;
            const methodDetails = document.getElementById('method-details');
            
            let html = '';
            
            if (methodType === 'card') {
                html = `
                    <div class="form-group">
                        <label for="card-number">Card Number</label>
                        <input type="text" id="card-number" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry-date">Expiry Date</label>
                            <input type="text" id="expiry-date" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="4">
                        </div>
                    </div>
                `;
            } else if (methodType === 'bank_transfer') {
                html = `
                    <div class="form-group">
                        <label for="account-number">Account Number</label>
                        <input type="text" id="account-number" placeholder="1234567890">
                    </div>
                    <div class="form-group">
                        <label for="routing-number">Routing Number</label>
                        <input type="text" id="routing-number" placeholder="123456789">
                    </div>
                    <div class="form-group">
                        <label for="account-type">Account Type</label>
                        <select id="account-type">
                            <option value="checking">Checking</option>
                            <option value="savings">Savings</option>
                        </select>
                    </div>
                `;
            } else if (methodType === 'crypto') {
                html = `
                    <div class="form-group">
                        <label for="wallet-address">Wallet Address</label>
                        <input type="text" id="wallet-address" placeholder="bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh">
                    </div>
                    <div class="form-group">
                        <label for="crypto-type">Cryptocurrency</label>
                        <select id="crypto-type">
                            <option value="BTC">Bitcoin</option>
                            <option value="ETH">Ethereum</option>
                            <option value="USDT">Tether</option>
                            <option value="USDC">USD Coin</option>
                        </select>
                    </div>
                `;
            } else if (methodType === 'paypal') {
                html = `
                    <div class="form-group">
                        <label for="paypal-email">PayPal Email</label>
                        <input type="email" id="paypal-email" placeholder="user@example.com">
                    </div>
                `;
            }
            
            methodDetails.innerHTML = html;
        }

        async function addPaymentMethod() {
            const methodType = document.getElementById('method-type').value;
            const methodName = document.getElementById('method-name').value;
            
            if (!methodType || !methodName) {
                showError('Please fill in all required fields');
                return;
            }
            
            let details = {};
            
            if (methodType === 'card') {
                details = {
                    card_number: document.getElementById('card-number').value,
                    expiry_date: document.getElementById('expiry-date').value,
                    cvv: document.getElementById('cvv').value
                };
            } else if (methodType === 'bank_transfer') {
                details = {
                    account_number: document.getElementById('account-number').value,
                    routing_number: document.getElementById('routing-number').value,
                    account_type: document.getElementById('account-type').value
                };
            } else if (methodType === 'crypto') {
                details = {
                    wallet_address: document.getElementById('wallet-address').value,
                    crypto_type: document.getElementById('crypto-type').value
                };
            } else if (methodType === 'paypal') {
                details = {
                    email: document.getElementById('paypal-email').value
                };
            }
            
            try {
                const response = await fetch(`${API_BASE}/payments/methods`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: methodType,
                        name: methodName,
                        details: details
                    })
                });
                
                if (response.ok) {
                    showSuccess('Payment method added successfully!');
                    closeAddMethodModal();
                    loadPaymentData(); // Refresh data
                } else {
                    showError('Failed to add payment method');
                }
            } catch (error) {
                showError('Error adding payment method: ' + error.message);
            }
        }

        async function deletePaymentMethod(methodId) {
            if (!confirm('Are you sure you want to delete this payment method?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/payments/methods/${methodId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                if (response.ok) {
                    showSuccess('Payment method deleted successfully!');
                    loadPaymentData(); // Refresh data
                } else {
                    showError('Failed to delete payment method');
                }
            } catch (error) {
                showError('Error deleting payment method: ' + error.message);
            }
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.textContent = message;
            
            const container = document.querySelector('.payments-container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => successDiv.remove(), 5000);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.payments-container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('add-method-modal');
            if (event.target === modal) {
                closeAddMethodModal();
            }
        }
    </script>
</body>
</html>